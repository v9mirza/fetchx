#!/usr/bin/env python3

import os
import sys
import platform
import shutil
import socket

# ================= FLAGS =================

ARGS = sys.argv[1:]
FULL = "--full" in ARGS
NETWORK = "--network" in ARGS
HELP = "--help" in ARGS or "-h" in ARGS
VERSION_FLAG = "--version" in ARGS

VERSION = "0.1.0"

# ================= ASCII LOGO =================

ASCII_LOGO = r"""
   ███████╗███████╗████████╗ ██████╗██╗  ██╗██╗  ██╗
   ██╔════╝██╔════╝╚══██╔══╝██╔════╝██║  ██║╚██╗██╔╝
   █████╗  █████╗     ██║   ██║     ███████║ ╚███╔╝
   ██╔══╝  ██╔══╝     ██║   ██║     ██╔══██║ ██╔██╗
   ██║     ███████╗   ██║   ╚██████╗██║  ██║██╔╝ ██╗
   ╚═╝     ╚══════╝   ╚═╝    ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝
"""

# ================= HELP / VERSION =================

if HELP:
    print(
        "fetchx — system snapshot tool\n\n"
        "Usage:\n"
        "  fetchx\n"
        "  fetchx --network\n"
        "  fetchx --full\n"
        "  fetchx --help\n"
        "  fetchx --version"
    )
    sys.exit(0)

if VERSION_FLAG:
    print(f"fetchx {VERSION}")
    sys.exit(0)

# ================= HELPERS =================

def os_name():
    try:
        with open("/etc/os-release") as f:
            for line in f:
                if line.startswith("PRETTY_NAME"):
                    return line.split("=", 1)[1].strip().strip('"')
    except:
        pass
    return platform.system()

def uptime():
    try:
        with open("/proc/uptime") as f:
            s = float(f.readline().split()[0])
        return f"{int(s//3600)}h {int((s%3600)//60)}m"
    except:
        return "unknown"

def memory():
    try:
        mem = {}
        with open("/proc/meminfo") as f:
            for line in f:
                k, v = line.split(":")
                mem[k] = int(v.strip().split()[0])
        used = (mem["MemTotal"] - mem["MemAvailable"]) // 1024
        total = mem["MemTotal"] // 1024
        return f"{used}MB / {total}MB"
    except:
        return "unknown"

def cpu():
    try:
        with open("/proc/cpuinfo") as f:
            for line in f:
                if "model name" in line:
                    return line.split(":", 1)[1].strip()
    except:
        pass
    return "unknown"

def cpu_cores():
    try:
        cores = set()
        threads = 0
        with open("/proc/cpuinfo") as f:
            for line in f:
                if line.startswith("core id"):
                    cores.add(line.strip())
                if line.startswith("processor"):
                    threads += 1
        return f"{len(cores)} cores / {threads} threads"
    except:
        return None

def gpus():
    try:
        out = os.popen("lspci | grep -Ei 'vga|3d|display'").read().strip()
        return [l.split(": ", 1)[1] for l in out.splitlines()] if out else []
    except:
        return []

def gpus_full():
    try:
        out = os.popen("lspci -k | grep -EA3 'vga|3d|display'").read().strip()
        g = []
        for block in out.split("\n\n"):
            lines = block.splitlines()
            name = lines[0].split(": ", 1)[1]
            driver = "unknown"
            for l in lines:
                if "Kernel driver in use" in l:
                    driver = l.split(": ", 1)[1]
            g.append(f"{name} ({driver})")
        return g
    except:
        return []

def packages():
    try:
        if shutil.which("pacman"):
            return os.popen("pacman -Qq | wc -l").read().strip()
        if shutil.which("dpkg"):
            return os.popen("dpkg -l | grep '^ii' | wc -l").read().strip()
        if shutil.which("rpm"):
            return os.popen("rpm -qa | wc -l").read().strip()
    except:
        pass
    return None

def desktop():
    return os.environ.get("XDG_CURRENT_DESKTOP") or os.environ.get("DESKTOP_SESSION") or "tty"

def terminal():
    return os.environ.get("TERM_PROGRAM") or os.environ.get("TERM") or "unknown"

def init_system():
    try:
        return open("/proc/1/comm").read().strip()
    except:
        return None

def session_type():
    if os.environ.get("WAYLAND_DISPLAY"):
        return "Wayland"
    if os.environ.get("DISPLAY"):
        return "X11"
    return None

def wsl():
    try:
        return "WSL" if "microsoft" in open("/proc/version").read().lower() else None
    except:
        return None

# ---------- Network helpers ----------

def interface():
    try:
        return os.popen("ip route | awk '/default/ {print $5}'").read().strip()
    except:
        return None

def local_ip():
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect(("8.8.8.8", 80))
        ip = s.getsockname()[0]
        s.close()
        return ip
    except:
        return None

def gateway():
    try:
        return os.popen("ip route | awk '/default/ {print $3}'").read().strip()
    except:
        return None

def mac_address(iface):
    try:
        return open(f"/sys/class/net/{iface}/address").read().strip()
    except:
        return None

def link_state(iface):
    try:
        return open(f"/sys/class/net/{iface}/operstate").read().strip()
    except:
        return None

def dns_servers():
    try:
        return ", ".join(
            l.split()[1] for l in open("/etc/resolv.conf") if l.startswith("nameserver")
        )
    except:
        return None

def external_ip():
    try:
        return os.popen("curl -fsSL https://api.ipify.org").read().strip()
    except:
        return None

def row(label, value):
    return f"\033[36m{label:<12}\033[0m {value}"

# ================= OUTPUT MODES =================

def show_default():
    print(row("OS:", os_name()))
    print(row("Kernel:", platform.release()))
    print(row("Host:", platform.node()))

    pkgs = packages()
    if pkgs:
        print(row("Packages:", pkgs))

    print(row("Desktop:", desktop()))
    print(row("CPU:", cpu()))

    for i, gpu in enumerate(gpus(), 1):
        print(row("GPU:" if i == 1 else f"GPU {i}:", gpu))

    print(row("Memory:", memory()))
    print(row("Uptime:", uptime()))
    print(row("Shell:", os.environ.get("SHELL", "unknown")))
    print(row("Terminal:", terminal()))
    print(row("User:", os.environ.get("USER", "unknown")))

def show_network():
    iface = interface()
    print(row("Interface:", iface or "unknown"))

    if iface:
        if mac_address(iface):
            print(row("MAC:", mac_address(iface)))
        if link_state(iface):
            print(row("Link:", link_state(iface)))

    if local_ip():
        print(row("Local IP:", local_ip()))
    if gateway():
        print(row("Gateway:", gateway()))
    if dns_servers():
        print(row("DNS:", dns_servers()))
    if external_ip():
        print(row("External IP:", external_ip()))

def show_full():
    # default
    show_default()
    print()

    # extra system
    print(row("Arch:", platform.machine()))
    if init_system():
        print(row("Init:", init_system()))
    if cpu_cores():
        print(row("CPU Cores:", cpu_cores()))
    if session_type():
        print(row("Session:", session_type()))
    if wsl():
        print(row("Environment:", wsl()))

    for i, gpu in enumerate(gpus_full(), 1):
        print(row("GPU Driver:" if i == 1 else f"GPU {i} Driver:", gpu))

    print()
    # network inline
    show_network()

# ================= MAIN =================

def main():
    print(ASCII_LOGO)

    if NETWORK:
        show_network()
    elif FULL:
        show_full()
    else:
        show_default()

if __name__ == "__main__":
    main()
