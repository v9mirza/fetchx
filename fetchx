#!/usr/bin/env python3

import os
import sys
import platform
import shutil
import socket
import subprocess
import json

# ================= FLAGS =================

ARGS = sys.argv[1:]
FULL = "--full" in ARGS
NETWORK = "--network" in ARGS
JSON_OUTPUT = "--json" in ARGS
COMPACT = "--compact" in ARGS
HELP = "--help" in ARGS or "-h" in ARGS
VERSION_FLAG = "--version" in ARGS

VERSION = "0.1.0"

# ================= ASCII LOGO =================

ASCII_LOGO = r"""
   ███████╗███████╗████████╗ ██████╗██╗  ██╗██╗  ██╗
   ██╔════╝██╔════╝╚══██╔══╝██╔════╝██║  ██║╚██╗██╔╝
   █████╗  █████╗     ██║   ██║     ███████║ ╚███╔╝
   ██╔══╝  ██╔══╝     ██║   ██║     ██╔══██║ ██╔██╗
   ██║     ███████╗   ██║   ╚██████╗██║  ██║██╔╝ ██╗
   ╚═╝     ╚══════╝   ╚═╝    ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝
"""

# ================= HELP / VERSION =================

if HELP:
    print(
        "fetchx — system snapshot tool\n\n"
        "Usage:\n"
        "  fetchx\n"
        "  fetchx --network\n"
        "  fetchx --full\n"
        "  fetchx --json\n"
        "  fetchx --compact\n"
        "  fetchx --help\n"
        "  fetchx --version"
    )
    sys.exit(0)

if VERSION_FLAG:
    print(f"fetchx {VERSION}")
    sys.exit(0)

# ================= HELPERS =================

def os_name():
    try:
        with open("/etc/os-release") as f:
            for line in f:
                if line.startswith("PRETTY_NAME"):
                    return line.split("=", 1)[1].strip().strip('"')
    except Exception:
        pass
    return platform.system()

def uptime():
    try:
        with open("/proc/uptime") as f:
            s = float(f.readline().split()[0])
        return f"{int(s//3600)}h {int((s%3600)//60)}m"
    except Exception:
        return "unknown"

def memory():
    try:
        mem = {}
        with open("/proc/meminfo") as f:
            for line in f:
                k, v = line.split(":")
                mem[k] = int(v.strip().split()[0])
        used = (mem["MemTotal"] - mem["MemAvailable"]) // 1024
        total = mem["MemTotal"] // 1024
        return f"{used}MB / {total}MB"
    except Exception:
        return "unknown"

def cpu():
    try:
        with open("/proc/cpuinfo") as f:
            for line in f:
                if "model name" in line:
                    return line.split(":", 1)[1].strip()
    except Exception:
        pass
    return "unknown"

def cpu_cores():
    try:
        cores = set()
        threads = 0
        with open("/proc/cpuinfo") as f:
            for line in f:
                if line.startswith("core id"):
                    cores.add(line.strip())
                if line.startswith("processor"):
                    threads += 1
        return f"{len(cores)} cores / {threads} threads"
    except Exception:
        return None

def gpus():
    try:
        p = subprocess.run("lspci | grep -Ei 'vga|3d|display'", shell=True, capture_output=True, text=True)
        out = p.stdout.strip()
        return [l.split(": ", 1)[1] for l in out.splitlines()] if out else []
    except Exception:
        return []

def gpus_full():
    try:
        p = subprocess.run("lspci -k | grep -EA3 'vga|3d|display'", shell=True, capture_output=True, text=True)
        out = p.stdout.strip()
        g = []
        for block in out.split("\n\n"):
            lines = block.splitlines()
            if not lines: continue
            name = lines[0].split(": ", 1)[1]
            driver = "unknown"
            for l in lines:
                if "Kernel driver in use" in l:
                    driver = l.split(": ", 1)[1]
            g.append(f"{name} ({driver})")
        return g
    except Exception:
        return []

def packages():
    try:
        # Fast path: Arch Linux
        if os.path.exists("/var/lib/pacman/local"):
             return str(len(os.listdir("/var/lib/pacman/local")) - 1) # -1 for ALPM_DB_VERSION

        # Fast path: Debian/Ubuntu
        if os.path.exists("/var/lib/dpkg/status"):
             with open("/var/lib/dpkg/status", "rb") as f:
                 # Count occurrences of "Status: install ok installed"
                 return str(f.read().count(b"Status: install ok installed"))
        
        # Fallback to slower commands if paths don't exist
        if shutil.which("rpm"):
            return subprocess.check_output("rpm -qa | wc -l", shell=True, text=True).strip()
    except Exception:
        pass
    return None

def desktop():
    return os.environ.get("XDG_CURRENT_DESKTOP") or os.environ.get("DESKTOP_SESSION") or "tty"

def terminal():
    return os.environ.get("TERM_PROGRAM") or os.environ.get("TERM") or "unknown"

def init_system():
    try:
        return open("/proc/1/comm").read().strip()
    except Exception:
        return None

def session_type():
    if os.environ.get("WAYLAND_DISPLAY"):
        return "Wayland"
    if os.environ.get("DISPLAY"):
        return "X11"
    return None

def wsl():
    try:
        return "WSL" if "microsoft" in open("/proc/version").read().lower() else None
    except Exception:
        return None

# ---------- Network helpers ----------

def interface():
    try:
        return subprocess.check_output("ip route | awk '/default/ {print $5}'", shell=True, text=True).strip()
    except Exception:
        return None

def local_ip():
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect(("8.8.8.8", 80))
        ip = s.getsockname()[0]
        s.close()
        return ip
    except Exception:
        return None

def gateway():
    try:
        return subprocess.check_output("ip route | awk '/default/ {print $3}'", shell=True, text=True).strip()
    except Exception:
        return None

def mac_address(iface):
    try:
        return open(f"/sys/class/net/{iface}/address").read().strip()
    except Exception:
        return None

def link_state(iface):
    try:
        return open(f"/sys/class/net/{iface}/operstate").read().strip()
    except Exception:
        return None

def dns_servers():
    try:
        return ", ".join(
            l.split()[1] for l in open("/etc/resolv.conf") if l.startswith("nameserver")
        )
    except Exception:
        return None

def external_ip():
    try:
        return subprocess.run(["curl", "-fsSL", "https://api.ipify.org"], capture_output=True, text=True).stdout.strip()
    except Exception:
        return None

def row(label, value):
    return f"\033[36m{label:<12}\033[0m {value}"

def disk_usage():
    try:
        du = shutil.disk_usage("/")
        used_gb = du.used // (1024**3)
        total_gb = du.total // (1024**3)
        percent = int((du.used / du.total) * 100)
        return f"{used_gb}GB / {total_gb}GB ({percent}%)"
    except Exception:
        return None

def battery():
    try:
        # Simple check for /sys/class/power_supply/BAT*
        bat_path = "/sys/class/power_supply"
        for d in os.listdir(bat_path):
            if d.startswith("BAT"):
                cap_file = os.path.join(bat_path, d, "capacity")
                stat_file = os.path.join(bat_path, d, "status")
                with open(cap_file) as f:
                    cap = int(f.read().strip())
                with open(stat_file) as f:
                    stat = f.read().strip()
                return f"{cap}% ({stat})"
    except Exception:
        pass
    return None

# ================= OUTPUT MODES =================

def show_default():
    print(row("OS:", os_name()))
    print(row("Kernel:", platform.release()))
    print(row("Host:", platform.node()))

    pkgs = packages()
    if pkgs:
        print(row("Packages:", pkgs))

    print(row("Desktop:", desktop()))
    print(row("CPU:", cpu()))

    for i, gpu in enumerate(gpus(), 1):
        print(row("GPU:" if i == 1 else f"GPU {i}:", gpu))

    print(row("Memory:", memory()))
    
    dsk = disk_usage()
    if dsk:
        print(row("Disk:", dsk))
        
    bat = battery()
    if bat:
        print(row("Battery:", bat))

    print(row("Uptime:", uptime()))
    print(row("Shell:", os.environ.get("SHELL", "unknown")))
    print(row("Terminal:", terminal()))
    print(row("User:", os.environ.get("USER", "unknown")))

def show_json():
    data = {
        "os": os_name(),
        "kernel": platform.release(),
        "host": platform.node(),
        "packages": packages(),
        "desktop": desktop(),
        "cpu": cpu(),
        "gpus": gpus(),
        "memory": memory(),
        "disk": disk_usage(),
        "battery": battery(),
        "uptime": uptime(),
        "shell": os.environ.get("SHELL"),
        "terminal": terminal(),
        "user": os.environ.get("USER"),
    }
    
    
    if NETWORK:
        data["network"] = {
            "interface": interface(),
            "local_ip": local_ip(),
            "gateway": gateway(),
            "dns": dns_servers(),
            "external_ip": external_ip(),
        }
         
    print(json.dumps(data, indent=2))

def show_network():
    iface = interface()
    print(row("Interface:", iface or "unknown"))

    if iface:
        if mac_address(iface):
            print(row("MAC:", mac_address(iface)))
        if link_state(iface):
            print(row("Link:", link_state(iface)))

    if local_ip():
        print(row("Local IP:", local_ip()))
    if gateway():
        print(row("Gateway:", gateway()))
    if dns_servers():
        print(row("DNS:", dns_servers()))
    if external_ip():
        print(row("External IP:", external_ip()))

def show_full():
    show_default()
    print()

    print(row("Arch:", platform.machine()))
    if init_system():
        print(row("Init:", init_system()))
    if cpu_cores():
        print(row("CPU Cores:", cpu_cores()))
    if session_type():
        print(row("Session:", session_type()))
    if wsl():
        print(row("Environment:", wsl()))

    for i, gpu in enumerate(gpus_full(), 1):
        print(row("GPU Driver:" if i == 1 else f"GPU {i} Driver:", gpu))

    print()
    show_network()

def show_compact():
    """
    Compact mode: user@host | OS | Kernel | Uptime | Mem: Used/Total
    """
    user = os.environ.get("USER", "unknown")
    host = platform.node()
    os_ = os_name()
    kern = platform.release()
    up = uptime().replace("h ", "h ").replace("m", "m")
    
    mem = memory().replace("MB", "")
    
    parts = [
        f"\033[36m{user}@{host}\033[0m",
        os_,
        f"Kernel {kern}",
        f"Up {up}",
        f"Mem {mem}MB"
    ]
    
    print(" | ".join(parts))

# ================= MAIN =================

def main():
    CYAN = "\033[36m"
    RESET = "\033[0m"
    if not JSON_OUTPUT and not COMPACT:
        print(f"{CYAN}{ASCII_LOGO}{RESET}")



    if JSON_OUTPUT:
        show_json()
    elif COMPACT:
        show_compact()
    elif NETWORK:
        show_network()
    elif FULL:
        show_full()
    else:
        show_default()

if __name__ == "__main__":
    main()
